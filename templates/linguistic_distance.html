{% extends "base.html" %}

{% block title %}Linguistic Distance Calculator - MEDEA-NEUMOUSA{% endblock %}

{% block content %}
<div class="container">
    <a href="/" class="back-link">← Return to MEDEA-NEUMOUSA</a>
    
    <div class="header">
        <h1 class="title">Linguistic Distance Calculator</h1>
        <p class="subtitle">Five-Dimensional Ancient Language Analysis</p>
        <p class="description">
            Measure the evolutionary distance between ancient languages using comprehensive 
            linguistic analysis across lexical, syntactic, typological, phonological, 
            and featural dimensions.
        </p>
    </div>

    <div class="card">
        <form id="distanceForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="language1">First Language</label>
                    <select id="language1" required>
                        <option value="">Loading languages...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="language2">Second Language</label>
                    <select id="language2" required>
                        <option value="">Loading languages...</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Analysis Dimensions</label>
                <div class="dimensions-grid">
                    <div class="dimension-checkbox">
                        <input type="checkbox" id="lexical" name="dimensions" value="lexical" checked>
                        <label for="lexical">Lexical (Swadesh)</label>
                    </div>
                    <div class="dimension-checkbox">
                        <input type="checkbox" id="syntactic" name="dimensions" value="syntactic" checked>
                        <label for="syntactic">Syntactic (UD)</label>
                    </div>
                    <div class="dimension-checkbox">
                        <input type="checkbox" id="typological" name="dimensions" value="typological" checked>
                        <label for="typological">Typological (WALS)</label>
                    </div>
                    <div class="dimension-checkbox">
                        <input type="checkbox" id="phonological" name="dimensions" value="phonological" checked>
                        <label for="phonological">Phonological (ASJP)</label>
                    </div>
                    <div class="dimension-checkbox">
                        <input type="checkbox" id="uriel" name="dimensions" value="uriel" checked>
                        <label for="uriel">Featural (URIEL+)</label>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button type="submit" class="btn">Calculate Linguistic Distance</button>
            </div>
        </form>
    </div>

    <div id="resultsContainer" class="results-container" style="margin-top: 3rem; display: none;">
        <div class="card">
            <h2 style="text-align: center; color: var(--accent-gold); margin-bottom: 2rem;">Analysis Results</h2>
            
            <div class="distance-score" style="text-align: center; margin: 2rem 0;">
                <div id="distanceValue" class="distance-value" style="font-size: 4rem; font-weight: 700; color: var(--accent-gold); font-family: 'Cinzel', serif;">0.000</div>
                <div class="distance-label" style="font-size: 1.2rem; color: var(--text-muted);">Overall Linguistic Distance</div>
                <div class="confidence-bar" style="width: 100%; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden; margin: 1rem 0;">
                    <div id="confidenceFill" class="confidence-fill" style="height: 100%; background: linear-gradient(90deg, var(--error-red), var(--warning-orange), var(--success-green)); transition: width 0.3s ease; width: 0%;"></div>
                </div>
                <div id="confidenceLabel" class="distance-label" style="font-size: 1.2rem; color: var(--text-muted);">Confidence: 0%</div>
            </div>

            <div id="componentsGrid" class="components-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0;">
                <!-- Component results will be inserted here -->
            </div>

            <div id="interpretation" class="interpretation" style="background: rgba(212, 175, 55, 0.1); border-left: 4px solid var(--accent-gold); padding: 1.5rem; margin: 2rem 0; font-style: italic; font-size: 1.1rem;">
                <!-- Interpretation will be inserted here -->
            </div>

            <div id="analysisDetails" style="margin-top: 2rem;">
                <!-- Additional analysis details -->
            </div>
        </div>
    </div>

    <div id="errorContainer" style="display: none;">
        <div class="error" id="errorMessage" style="background: rgba(244, 67, 54, 0.1); border: 1px solid var(--error-red); color: var(--error-red); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
            <!-- Error message will be shown here -->
        </div>
    </div>
</div>

<style>
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .form-group {
        margin-bottom: 2rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--accent-gold);
        font-weight: 600;
        font-size: 1.1rem;
    }

    .form-group select {
        width: 100%;
        padding: 1rem;
        background: rgba(26, 31, 58, 0.8);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-light);
        font-size: 1rem;
        font-family: inherit;
    }

    .form-group select:focus {
        outline: none;
        border-color: var(--accent-gold);
        box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
    }

    .dimensions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .dimension-checkbox {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        background: rgba(212, 175, 55, 0.1);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .dimension-checkbox:hover {
        background: rgba(212, 175, 55, 0.2);
        border-color: var(--accent-gold);
    }

    .dimension-checkbox input {
        width: auto;
    }

    .component-card {
        background: rgba(26, 31, 58, 0.6);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
    }

    .component-value {
        font-size: 2rem;
        font-weight: 600;
        color: var(--accent-gold);
        margin-bottom: 0.5rem;
    }

    .component-label {
        color: var(--text-muted);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .loading {
        text-align: center;
        padding: 2rem;
        color: var(--text-muted);
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
    }
</style>

<script>
    let availableLanguages = [];

    // Load available languages on page load
    async function loadLanguages() {
        try {
            const response = await fetch('/api/v1/linguistic-distance/languages');
            const languages = await response.json();
            availableLanguages = languages;
            
            const select1 = document.getElementById('language1');
            const select2 = document.getElementById('language2');
            
            // Clear loading options
            select1.innerHTML = '<option value="">Select first language...</option>';
            select2.innerHTML = '<option value="">Select second language...</option>';
            
            // Add language options
            languages.forEach(lang => {
                const option1 = new Option(`${lang.name} (${lang.family})`, lang.name);
                const option2 = new Option(`${lang.name} (${lang.family})`, lang.name);
                
                if (!lang.available) {
                    option1.disabled = true;
                    option2.disabled = true;
                    option1.text += ' - No data';
                    option2.text += ' - No data';
                }
                
                select1.add(option1);
                select2.add(option2);
            });
        } catch (error) {
            console.error('Error loading languages:', error);
            showError('Failed to load available languages. Please refresh the page.');
        }
    }

    // Handle form submission
    document.getElementById('distanceForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const language1 = document.getElementById('language1').value;
        const language2 = document.getElementById('language2').value;
        const selectedDimensions = Array.from(document.querySelectorAll('input[name="dimensions"]:checked'))
            .map(cb => cb.value);

        if (!language1 || !language2) {
            showError('Please select both languages.');
            return;
        }

        if (language1 === language2) {
            showError('Please select two different languages.');
            return;
        }

        if (selectedDimensions.length === 0) {
            showError('Please select at least one analysis dimension.');
            return;
        }

        // Show loading state
        showLoading();

        try {
            const response = await fetch('/api/v1/linguistic-distance/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    language1: language1,
                    language2: language2,
                    analysis_dimensions: selectedDimensions
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Analysis failed');
            }

            const result = await response.json();
            displayResults(result);
            
        } catch (error) {
            console.error('Error calculating distance:', error);
            showError(error.message || 'Failed to calculate linguistic distance. Please try again.');
        }
    });

    function showLoading() {
        document.getElementById('errorContainer').style.display = 'none';
        document.getElementById('resultsContainer').style.display = 'block';
        
        // Show loading state
        document.querySelector('.card h2').textContent = 'Analyzing Languages...';
        document.getElementById('distanceValue').textContent = '...';
        document.getElementById('componentsGrid').innerHTML = '<div class="loading">Running comprehensive linguistic analysis...</div>';
        document.getElementById('interpretation').innerHTML = '<div class="loading">This may take a few moments...</div>';
    }

    function displayResults(result) {
        document.getElementById('errorContainer').style.display = 'none';
        document.getElementById('resultsContainer').style.display = 'block';
        
        // Update header
        document.querySelector('.card h2').textContent = `${result.language1} ↔ ${result.language2}`;
        
        // Update distance value
        document.getElementById('distanceValue').textContent = result.overall_distance.toFixed(3);
        
        // Update confidence
        const confidencePercent = Math.round(result.confidence_score * 100);
        document.getElementById('confidenceFill').style.width = confidencePercent + '%';
        document.getElementById('confidenceLabel').textContent = `Confidence: ${confidencePercent}%`;
        
        // Update component distances
        const componentsGrid = document.getElementById('componentsGrid');
        componentsGrid.innerHTML = '';
        
        Object.entries(result.component_distances).forEach(([dimension, distance]) => {
            const componentCard = document.createElement('div');
            componentCard.className = 'component-card';
            
            const isAvailable = result.available_data[dimension];
            const displayValue = distance !== null ? distance.toFixed(3) : 'N/A';
            const opacity = isAvailable ? '1' : '0.5';
            
            componentCard.innerHTML = `
                <div class="component-value" style="opacity: ${opacity}">${displayValue}</div>
                <div class="component-label">${dimension.charAt(0).toUpperCase() + dimension.slice(1)}</div>
                ${!isAvailable ? '<div style="color: var(--warning-orange); font-size: 0.8rem; margin-top: 0.5rem;">No data</div>' : ''}
            `;
            
            componentsGrid.appendChild(componentCard);
        });
        
        // Update interpretation
        document.getElementById('interpretation').innerHTML = `
            <strong>Interpretation:</strong><br>
            ${result.interpretation}
        `;
        
        // Update analysis details
        document.getElementById('analysisDetails').innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
                <div>
                    <strong style="color: var(--accent-gold);">Analysis Summary:</strong><br>
                    ${result.analysis_summary}
                </div>
                <div>
                    <strong style="color: var(--accent-gold);">Language Families:</strong><br>
                    ${result.language1}: ${result.family_info.language1_family}<br>
                    ${result.language2}: ${result.family_info.language2_family}
                </div>
            </div>
        `;
    }

    function showError(message) {
        document.getElementById('resultsContainer').style.display = 'none';
        document.getElementById('errorContainer').style.display = 'block';
        document.getElementById('errorMessage').textContent = message;
    }

    // Load languages when page loads
    document.addEventListener('DOMContentLoaded', loadLanguages);
</script>
{% endblock %}